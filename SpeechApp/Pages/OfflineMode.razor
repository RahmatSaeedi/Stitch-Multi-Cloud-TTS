@page "/offline"
@using SpeechApp.Services.Interfaces
@using SpeechApp.Services.Offline
@using SpeechApp.Models
@inject ISnackbar Snackbar
@inject IJSRuntime JS
@inject PiperTTSService PiperService

<PageTitle>Offline Mode - Stitch TTS</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4 mb-8">
    <MudText Typo="Typo.h4" Class="mb-2">
        <MudIcon Icon="@Icons.Material.Filled.CloudOff" Class="mr-2" />
        Offline Text-to-Speech - Piper TTS
    </MudText>
    <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-6">
        Download high-quality neural voice models for offline speech synthesis. Works without internet after installation.
    </MudText>

    <!-- Storage Quota Display -->
    <MudAlert Severity="Severity.Info" Class="mb-4">
        <MudGrid>
            <MudItem xs="12" sm="6">
                <MudText Typo="Typo.body2">
                    <strong>Storage Used:</strong> @_storageUsedFormatted
                </MudText>
            </MudItem>
            <MudItem xs="12" sm="6">
                <MudText Typo="Typo.body2">
                    <strong>Browser Limit:</strong> ~1 GB (varies by browser)
                </MudText>
            </MudItem>
        </MudGrid>
        <MudProgressLinear Value="@_storagePercentage" Color="@GetStorageColor()" Class="mt-2" />
    </MudAlert>

    <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6">
        <!-- Piper TTS Tab -->
        <MudTabPanel Text="Piper TTS" Icon="@Icons.Material.Filled.HighQuality">
            <MudText Typo="Typo.h6" Class="mb-3">
                <MudIcon Icon="@Icons.Material.Filled.Star" Color="Color.Warning" Size="Size.Small" Class="mr-1" />
                Piper - High-Quality Offline TTS
            </MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
                Neural voices with natural prosody. Each model is 50-120 MB. Best quality offline option.
            </MudText>

            @if (_piperAvailableModels == null)
            {
                <MudProgressCircular Indeterminate="true" />
            }
            else
            {
                <MudGrid>
                    @foreach (var model in _piperAvailableModels)
                    {
                        <MudItem xs="12" md="6" lg="4">
                            <MudCard Outlined="true">
                                <MudCardContent>
                                    <MudText Typo="Typo.h6">@model.Name</MudText>
                                    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-2">
                                        @model.Language â€¢ @model.Gender
                                    </MudText>
                                    <MudText Typo="Typo.caption" Class="mb-2">
                                        @model.Description
                                    </MudText>
                                    <MudChip T="string" Size="Size.Small" Color="Color.Info">@model.GetFormattedSize()</MudChip>
                                    <MudChip T="string" Size="Size.Small" Color="Color.Success">@model.Quality</MudChip>
                                </MudCardContent>
                                <MudCardActions>
                                    @if (model.IsDownloaded)
                                    {
                                        <MudButton Variant="Variant.Text"
                                                   Color="Color.Success"
                                                   StartIcon="@Icons.Material.Filled.CheckCircle"
                                                   Disabled="true">
                                            Downloaded
                                        </MudButton>
                                        <MudSpacer />
                                        <MudButton Variant="Variant.Text"
                                                   Color="Color.Error"
                                                   StartIcon="@Icons.Material.Filled.Delete"
                                                   OnClick="@(() => RemovePiperModel(model.Id))">
                                            Remove
                                        </MudButton>
                                    }
                                    else
                                    {
                                        <MudButton Variant="Variant.Filled"
                                                   Color="Color.Primary"
                                                   StartIcon="@Icons.Material.Filled.Download"
                                                   Disabled="@_isDownloading"
                                                   OnClick="@(() => DownloadPiperModel(model.Id))">
                                            Download
                                        </MudButton>
                                    }
                                </MudCardActions>

                                @if (_downloadingModelId == model.Id && _isDownloading)
                                {
                                    <MudProgressLinear Value="@_downloadProgress" Color="Color.Primary" Class="mt-2" />
                                    <MudText Typo="Typo.caption" Align="Align.Center" Class="mt-1">
                                        Downloading... @_downloadProgress%
                                    </MudText>
                                }
                            </MudCard>
                        </MudItem>
                    }
                </MudGrid>
            }
        </MudTabPanel>

        <!-- Help Tab -->
        <MudTabPanel Text="Help & Info" Icon="@Icons.Material.Filled.Help">
            <MudText Typo="Typo.h6" Class="mb-3">About Offline TTS</MudText>

            <MudExpansionPanels MultiExpansion="true">
                <MudExpansionPanel Text="How does offline TTS work?">
                    <MudText Typo="Typo.body2">
                        Offline TTS uses Piper, a high-quality neural TTS engine compiled to WebAssembly that runs entirely in your browser.
                        Voice models are downloaded once and stored in your browser's IndexedDB. After download,
                        synthesis happens locally without any internet connection.
                    </MudText>
                </MudExpansionPanel>

                <MudExpansionPanel Text="About Piper TTS">
                    <MudText Typo="Typo.body2" Class="mb-2">
                        Piper provides high-quality neural voices with natural prosody. Each voice model is 50-120 MB and supports:
                    </MudText>
                    <MudList T="string" Dense="true">
                        <MudListItem T="string" Icon="@Icons.Material.Filled.Check">Natural-sounding speech with good prosody</MudListItem>
                        <MudListItem T="string" Icon="@Icons.Material.Filled.Check">124 voices across 50+ languages</MudListItem>
                        <MudListItem T="string" Icon="@Icons.Material.Filled.Check">Multiple quality levels (low, medium, high)</MudListItem>
                        <MudListItem T="string" Icon="@Icons.Material.Filled.Check">Completely offline operation after download</MudListItem>
                    </MudList>
                </MudExpansionPanel>

                <MudExpansionPanel Text="Storage & Browser Limits">
                    <MudText Typo="Typo.body2" Class="mb-2">
                        Most modern browsers allow ~1 GB of storage for Progressive Web Apps. This is shared across:
                    </MudText>
                    <MudList T="string" Dense="true">
                        <MudListItem T="string" Icon="@Icons.Material.Filled.Storage">Voice models (Piper)</MudListItem>
                        <MudListItem T="string" Icon="@Icons.Material.Filled.Storage">Voice cache (14-day TTL)</MudListItem>
                        <MudListItem T="string" Icon="@Icons.Material.Filled.Storage">Application cache (service worker)</MudListItem>
                    </MudList>
                    <MudText Typo="Typo.body2" Class="mt-2">
                        You can download approximately 8-15 Piper models before reaching the limit.
                        The app will automatically manage storage and warn you when approaching limits.
                    </MudText>
                </MudExpansionPanel>

                <MudExpansionPanel Text="Privacy & Security">
                    <MudText Typo="Typo.body2">
                        Offline TTS is the most private option. Your text never leaves your device, and no
                        internet connection is required after model download. Models are stored securely in
                        IndexedDB and can only be accessed by this application.
                    </MudText>
                </MudExpansionPanel>
            </MudExpansionPanels>

            <MudAlert Severity="Severity.Warning" Class="mt-4">
                <strong>Note:</strong> Offline TTS requires modern browser with WebAssembly support.
                Not available in private/incognito mode due to storage restrictions.
            </MudAlert>
        </MudTabPanel>
    </MudTabs>
</MudContainer>

@code {
    private List<OfflineVoiceModel>? _piperAvailableModels;
    private long _storageUsed;
    private string _storageUsedFormatted = "0 MB";
    private double _storagePercentage;

    private bool _isDownloading;
    private string? _downloadingModelId;
    private int _downloadProgress;

    protected override async Task OnInitializedAsync()
    {
        // Services are now properly injected via @inject directives
        await LoadModels();
        await UpdateStorageInfo();
    }

    private async Task LoadModels()
    {
        if (PiperService != null)
        {
            _piperAvailableModels = await PiperService.GetAvailableModelsAsync();
            var downloaded = await PiperService.GetDownloadedModelsAsync();

            // Mark downloaded models
            foreach (var model in _piperAvailableModels)
            {
                model.IsDownloaded = downloaded.Any(d => d.Id == model.Id);
            }
        }
    }

    private async Task UpdateStorageInfo()
    {
        if (PiperService != null)
        {
            _storageUsed = await PiperService.GetTotalModelSizeAsync();
            _storageUsedFormatted = FormatBytes(_storageUsed);

            // Assume 1 GB browser limit
            var limit = 1024L * 1024 * 1024;
            _storagePercentage = (_storageUsed / (double)limit) * 100;
        }
    }

    private async Task DownloadPiperModel(string modelId)
    {
        _isDownloading = true;
        _downloadingModelId = modelId;
        _downloadProgress = 0;

        try
        {
            var success = await PiperService!.DownloadModelAsync(modelId, progress =>
            {
                _downloadProgress = progress;
                InvokeAsync(StateHasChanged);
            });

            if (success)
            {
                Snackbar.Add($"Model downloaded successfully!", Severity.Success);
                await LoadModels();
                await UpdateStorageInfo();
            }
            else
            {
                Snackbar.Add("Download failed. Please try again.", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isDownloading = false;
            _downloadingModelId = null;
            _downloadProgress = 0;
        }
    }

    private async Task RemovePiperModel(string modelId)
    {
        var confirmed = await JS.InvokeAsync<bool>("confirm", "Are you sure you want to remove this voice model?");

        if (confirmed && PiperService != null)
        {
            var success = await PiperService.RemoveModelAsync(modelId);

            if (success)
            {
                Snackbar.Add("Model removed successfully", Severity.Success);
                await LoadModels();
                await UpdateStorageInfo();
            }
            else
            {
                Snackbar.Add("Failed to remove model", Severity.Error);
            }
        }
    }

    private Color GetStorageColor()
    {
        if (_storagePercentage < 50) return Color.Success;
        if (_storagePercentage < 75) return Color.Warning;
        return Color.Error;
    }

    private string FormatBytes(long bytes)
    {
        if (bytes < 1024) return $"{bytes} B";
        if (bytes < 1024 * 1024) return $"{bytes / 1024.0:F1} KB";
        if (bytes < 1024 * 1024 * 1024) return $"{bytes / (1024.0 * 1024.0):F1} MB";
        return $"{bytes / (1024.0 * 1024.0 * 1024.0):F2} GB";
    }
}
